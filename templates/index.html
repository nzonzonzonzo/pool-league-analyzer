<!DOCTYPE html>
<html>
<head>
    <title>Amsterdam Billiards League Stats Analyzer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { padding-top: 20px; }
        .hidden { display: none; }
        .card { margin-bottom: 20px; }
        .matchup-row { margin-bottom: 10px; }
        .optimal-lineup { background-color: #e7f7e7; padding: 15px; border-radius: 5px; margin-top: 20px; }
        .probability-high { color: green; }
        .probability-medium { color: orange; }
        .probability-low { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Amsterdam Billiards League Stats Analyzer</h1>
        
        {% if not has_teams_file %}
        <div class="card" id="teams-card">
            <div class="card-header">
                <h5>Step 1: Upload Team Data</h5>
            </div>
            <div class="card-body">
                <form id="teams-form">
                    <div class="mb-3">
                        <label for="teams-content" class="form-label">Paste the teams data here</label>
                        <textarea class="form-control" id="teams-content" name="teams_content" rows="10" required
                            placeholder="Team Name&#9;URL&#10;Team Name&#9;URL"></textarea>
                        <div class="form-text">Format: Team Name [Tab] URL (one per line)</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Team Data</button>
                </form>
                <div id="teams-result" class="mt-3 hidden alert"></div>
            </div>
        </div>
        {% elif not has_data %}
        <div class="card" id="scraper-card">
            <div class="card-header">
                <h5>Step 2: Scrape League Data</h5>
            </div>
            <div class="card-body">
                <p>Team data has been uploaded. Now let's scrape the player statistics.</p>
                <form id="scrape-form">
                    <div class="mb-3">
                        <label for="cookie" class="form-label">Authentication Cookie (optional)</label>
                        <input type="text" class="form-control" id="cookie" name="cookie" value="qJy9wAvA%2B3sZ08JkrfHGxA%3D%3D">
                        <div class="form-text">The default cookie should work. Only change if you have authentication issues.</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Scrape Data</button>
                </form>
                <div id="scrape-result" class="mt-3 hidden alert"></div>
            </div>
        </div>
        {% else %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>Analyze Matchups</h5>
            </div>
            <div class="card-body">
                <form id="analysis-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="our-team" class="form-label">Your Team</label>
                                <select class="form-select" id="our-team" name="our_team" required>
                                    <option value="">Select your team</option>
                                    {% for team in teams %}
                                    <option value="{{ team }}">{{ team }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="opponent-team" class="form-label">Opponent Team</label>
                                <select class="form-select" id="opponent-team" name="opponent_team" required>
                                    <option value="">Select opponent team</option>
                                    {% for team in teams %}
                                    <option value="{{ team }}">{{ team }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Analyze Matchups</button>
                </form>
            </div>
        </div>
        
        <div id="analysis-result" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h5>Optimal Lineup</h5>
                </div>
                <div class="card-body">
                    <div id="optimal-lineup"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5>All Possible Matchups</h5>
                </div>
                <div class="card-body">
                    <div id="all-matchups"></div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <button id="scrape-new-btn" class="btn btn-secondary">Scrape New Data</button>
        </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Teams form submission
            const teamsForm = document.getElementById('teams-form');
            if (teamsForm) {
                teamsForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(teamsForm);
                    const resultDiv = document.getElementById('teams-result');
                    resultDiv.classList.remove('hidden', 'alert-success', 'alert-danger');
                    resultDiv.classList.add('alert-info');
                    resultDiv.innerHTML = 'Saving team data...';
                    
                    fetch('/upload_teams', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        resultDiv.classList.remove('alert-info');
                        if (data.success) {
                            resultDiv.classList.add('alert-success');
                            resultDiv.innerHTML = data.message + ' Refreshing page...';
                            setTimeout(() => window.location.reload(), 2000);
                        } else {
                            resultDiv.classList.add('alert-danger');
                            resultDiv.innerHTML = data.message;
                        }
                    })
                    .catch(error => {
                        resultDiv.classList.remove('alert-info');
                        resultDiv.classList.add('alert-danger');
                        resultDiv.innerHTML = 'Error: ' + error;
                    });
                });
            }
            
            // Scrape form submission
            const scrapeForm = document.getElementById('scrape-form');
            if (scrapeForm) {
                scrapeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(scrapeForm);
                    const resultDiv = document.getElementById('scrape-result');
                    resultDiv.classList.remove('hidden', 'alert-success', 'alert-danger');
                    resultDiv.classList.add('alert-info');
                    resultDiv.innerHTML = 'Scraping data... This may take a few minutes.';
                    
                    fetch('/scrape', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        resultDiv.classList.remove('alert-info');
                        if (data.success) {
                            resultDiv.classList.add('alert-success');
                            resultDiv.innerHTML = data.message + ' Refreshing page...';
                            setTimeout(() => window.location.reload(), 2000);
                        } else {
                            resultDiv.classList.add('alert-danger');
                            resultDiv.innerHTML = data.message;
                        }
                    })
                    .catch(error => {
                        resultDiv.classList.remove('alert-info');
                        resultDiv.classList.add('alert-danger');
                        resultDiv.innerHTML = 'Error: ' + error;
                    });
                });
            }
            
            // Analysis form submission
            const analysisForm = document.getElementById('analysis-form');
            if (analysisForm) {
                analysisForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(analysisForm);
                    const resultDiv = document.getElementById('analysis-result');
                    const optimalDiv = document.getElementById('optimal-lineup');
                    const matchupsDiv = document.getElementById('all-matchups');
                    
                    // Clear previous results
                    optimalDiv.innerHTML = 'Analyzing matchups...';
                    matchupsDiv.innerHTML = '';
                    resultDiv.classList.remove('hidden');
                    
                    fetch('/analyze', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Display optimal lineup
                            if (data.optimal_lineup && data.optimal_lineup.length > 0) {
                                let optimalHtml = `<p class="lead">Expected win probability: <strong>${data.overall_probability}%</strong></p>`;
                                optimalHtml += '<table class="table table-striped">';
                                optimalHtml += '<thead><tr><th>Your Player</th><th>Opponent</th><th>Win Probability</th><th>Handicap Diff</th></tr></thead>';
                                optimalHtml += '<tbody>';
                                
                                data.optimal_lineup.forEach(match => {
                                    let probClass = '';
                                    if (match.win_probability >= 60) probClass = 'probability-high';
                                    else if (match.win_probability >= 40) probClass = 'probability-medium';
                                    else probClass = 'probability-low';
                                    
                                    optimalHtml += `<tr>
                                        <td><a href="/player_stats/${encodeURIComponent(match.our_player)}" target="_blank">${match.our_player}</a> (${match.our_handicap})</td>
                                        <td>${match.opponent} (${match.opponent_handicap})</td>
                                        <td class="${probClass}">${match.win_probability}%</td>
                                        <td>${match.handicap_diff}</td>
                                    </tr>`;
                                });
                                
                                optimalHtml += '</tbody></table>';
                                optimalDiv.innerHTML = optimalHtml;
                            } else {
                                optimalDiv.innerHTML = '<div class="alert alert-warning">Could not calculate optimal lineup. Insufficient data.</div>';
                            }
                            
                            // Display all possible matchups
                            if (Object.keys(data.matchups).length === 0) {
                                matchupsDiv.innerHTML = '<div class="alert alert-warning">No matchup data available.</div>';
                            } else {
                                let matchupsHtml = '';
                                
                                for (const [player, opponents] of Object.entries(data.matchups)) {
                                    matchupsHtml += `<h4><a href="/player_stats/${encodeURIComponent(player)}" target="_blank">${player}</a></h4>`;
                                    matchupsHtml += '<table class="table table-sm">';
                                    matchupsHtml += '<thead><tr><th>Opponent</th><th>Win Probability</th><th>Handicap Diff</th></tr></thead>';
                                    matchupsHtml += '<tbody>';
                                    
                                    opponents.forEach(opp => {
                                        let probClass = '';
                                        if (opp.win_probability >= 60) probClass = 'probability-high';
                                        else if (opp.win_probability >= 40) probClass = 'probability-medium';
                                        else probClass = 'probability-low';
                                        
                                        matchupsHtml += `<tr>
                                            <td>${opp.name} (${opp.handicap})</td>
                                            <td class="${probClass}">${opp.win_probability}%</td>
                                            <td>${opp.handicap_diff}</td>
                                        </tr>`;
                                    });
                                    
                                    matchupsHtml += '</tbody></table>';
                                }
                                
                                matchupsDiv.innerHTML = matchupsHtml;
                            }
                        } else {
                            optimalDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                            matchupsDiv.innerHTML = '';
                        }
                    })
                    .catch(error => {
                        optimalDiv.innerHTML = `<div class="alert alert-danger">Error: ${error}</div>`;
                        matchupsDiv.innerHTML = '';
                    });
                });
            }
            
            // Scrape new data button
            const scrapeNewBtn = document.getElementById('scrape-new-btn');
            if (scrapeNewBtn) {
                scrapeNewBtn.addEventListener('click', function() {
                    window.location.href = '/?force_scrape=1';
                });
            }
        });
    </script>
</body>
</html>